import { Injectable } from "@angular/core";
import { NameRefactorService } from "./nameRefactor.service";

import * as area from "@mapbox/geojson-area";
import * as Turf from "@turf/turf";
import * as togeojson from "@mapbox/togeojson";
import * as mbxClient from "@mapbox/mapbox-sdk";

@Injectable()
export class MapStaticService {
  constructor(private nameRefactorService: NameRefactorService) {}

  refactorCoordinates(coordinates) {
    var string = coordinates.split(" ");

    while (string[string.length - 1] == "") {
      string.splice(string.length - 1, 1);
    }

    var a = string.length;

    for (var i = 0; i < a; i++) {
      if (
        parseFloat(string[i].split(",")["0"]) < -90 ||
        parseFloat(string[i].split(",")["0"]) > 90 ||
        parseFloat(string[i].split(",")["1"]) < -180 ||
        parseFloat(string[i].split(",")["1"]) > 180
      ) {
        return "error";
      }
    }

    var ar = [];
    for (var i = 0; i < a; i++) {
      var tempo = string[i].split(",");
      for (var j = 0; j < tempo.length; j++) {
        tempo[j] = parseFloat(tempo[j]);
      }
      ar.push(tempo);
    }

    var res = [];
    res.push(ar);
    try {
      Turf.polygon(res);
    } catch (error) {
      return "error";
    }
    console.log();

    return res;
  }

  checkIsValidCoordinate(coord, type) {
    let isValid;

    switch (type) {
      case "lat":
        isValid = coord <= 90 && coord >= -90;
        break;
      case "lng":
        isValid = coord <= 180 && coord >= -180;
        break;
    }

    return isValid;
  }

  googleMapUrl(ar) {
    var a = ar.length;
    ar = ar["0"];

    var url = "https://maps.googleapis.com/maps/api/staticmap?path=color:0x0000ff%7Cweight:5%7C";

    for (var i = 0; i < ar.length; i++) {
      url += ar[i]["1"] + "," + ar[i]["0"];
      if (i !== ar.length - 1) {
        url += "|";
      }
    }

    url += "&size=700x700&zoom=9&key=AIzaSyCOm1K8tIc7J9GpKEjCKp4VnCwVukqic2g";

    return url;
  }

  googleMapUrlPoint(ar) {
    var a = ar.length;
    var url = "https://maps.googleapis.com/maps/api/staticmap?path=color:0x0000ff%7Cweight:5%7C";
    url += ar["1"] + "," + ar["0"] + "&markers=color:green%7Clabel:T%7C" + ar["1"] + "," + ar["0"];
    url += "&size=700x700&zoom=9&key=AIzaSyCOm1K8tIc7J9GpKEjCKp4VnCwVukqic2g";
    return url;
  }

  setAllStaticMapToB64(platform, zone) {
    let token = "pk.eyJ1Ijoic3lsdmllZmlhdCIsImEiOiJjamk1MnZieGMwMTUxM3FxbDRhb2o5dDc3In0.V8jhcEcPBkyugxnw5gj2uw";
    console.log(zone);
    const baseClient = mbxClient({ accessToken: token });
    delete zone["codePlatform"];
    delete zone["codePlatform"];
    delete zone["staticmap"];
    delete zone["stations"];
    delete zone["zonePreferences"];

    var geojson = {
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [125.6, 10.1]
      },
      properties: {
        name: "Dinagat Islands"
      }
    };

    console.log(zone);
    baseClient.static
      .getStaticImage({
        ownerId: "mapbox",
        styleId: "streets-v10",
        width: 1000,
        height: 1000,
        coordinates: [125.6, 10.1],
        zoom: 8,
        geojson: {
          type: "Feature",
          geometry: {
            type: "Polygon",
            coordinates: [
              [
                [55.19734014540896, -4.460191618149105],
                [55.19612324760185, -4.461403235618675],
                [55.19551669321881, -4.463829715512229],
                [55.1955187698018, -4.466257509370275],
                [55.19552139450015, -4.469292120452231],
                [55.19552313804621, -4.471719492873041],
                [55.19552470627515, -4.474147125928663],
                [55.194918405304, -4.476572428336765],
                [55.19492024002078, -4.478999829404111],
                [55.19492230207987, -4.48142745677016],
                [55.19553338632412, -4.484462404906444],
                [55.19675222350642, -4.486890446883627],
                [55.19675427147023, -4.489317236934393],
                [55.19736495750374, -4.491744938837872],
                [55.19858432854729, -4.494173484376585],
                [55.19919468800075, -4.4966008072529],
                [55.20163151189278, -4.499030846994227],
                [55.20284985226385, -4.500245851908662],
                [55.20528677599003, -4.503282264391032],
                [55.20711353889759, -4.50449794994311],
                [55.20954946663279, -4.506321039660268],
                [55.21198493685746, -4.507537562069026],
                [55.21320350743259, -4.509965151950295],
                [55.21442166561519, -4.51239235400648],
                [55.21503103361923, -4.514212214309641],
                [55.21685832583539, -4.517852655014701],
                [55.21746763844531, -4.51967236929182],
                [55.21929408546528, -4.521493688808651],
                [55.22233725965878, -4.522710232954124],
                [55.22477146385002, -4.523319564164746],
                [55.22781387782343, -4.523323445507255],
                [55.23024772786455, -4.523326545878229],
                [55.23207350572889, -4.523329062588987],
                [55.23450701655825, -4.523332184602094],
                [55.23937280443555, -4.522733818578853],
                [55.24119799012512, -4.522734026898378],
                [55.24302296823645, -4.522130082580969],
                [55.24545604208095, -4.521526771753988],
                [55.24788931723799, -4.520923766987225],
                [55.25032163779714, -4.519713775012931],
                [55.25214575606321, -4.517897327442257],
                [55.25518655259852, -4.516082378201403],
                [55.25761843627212, -4.51426651910677],
                [55.25944252392809, -4.513056137244366],
                [55.26126588864999, -4.509420889993054],
                [55.26308928232339, -4.505785786469771],
                [55.26369662485757, -4.503361545243059],
                [55.26551914931772, -4.499119793661712],
                [55.26612643891171, -4.496695245803198],
                [55.26612509951359, -4.493057107165209],
                [55.26612390107173, -4.490025054794826],
                [55.26612293819857, -4.487599339653993],
                [55.2655140755411, -4.485778640714276],
                [55.26490465428106, -4.48274662523377],
                [55.26490327654833, -4.47971411593568],
                [55.2642936718261, -4.476680601380498],
                [55.26368459628779, -4.473645718540867],
                [55.26246702470949, -4.471217855426936],
                [55.26124867584343, -4.468790512758904],
                [55.25942271069317, -4.466361565515918],
                [55.25759675232121, -4.464538851290916],
                [55.25516282295671, -4.463321789106951],
                [55.25394512358224, -4.461499864022568],
                [55.25151139296117, -4.460282976200227],
                [55.2484686874518, -4.459064816876425],
                [55.24664225646451, -4.457241626351557],
                [55.24420725983747, -4.456617150862062],
                [55.24177337876883, -4.455413139813875],
                [55.23873113600952, -4.454804933444571],
                [55.2356870881091, -4.453582775372667],
                [55.23203499027544, -4.452970325657372],
                [55.23081730176528, -4.452361345897024],
                [55.22777415941387, -4.452356244213364],
                [55.22351367458565, -4.452348753751593],
                [55.22046983541764, -4.452343466360542],
                [55.21742606750197, -4.452338090741689],
                [55.21194740324588, -4.45293548627554],
                [55.2095120312144, -4.452931005593697],
                [55.20707669616552, -4.452926583222157],
                [55.20464276861856, -4.454742827388479],
                [55.20220796370471, -4.455952304935751],
                [55.20038240764998, -4.457162489966723],
                [55.19794810211319, -4.45897887407234],
                [55.19734014540896, -4.460191618149105]
              ]
            ]
          },
          properties: {
            name: "La Digue",
            description: "zone de La Digue",
            code: "sey_LaDigue",
            surface: 49512623
          }
        }
      })
      .send()
      .then(response => {
        console.log(response);
        const image = response.body;
        var blob = new Blob([image], { type: "image/png" });
        console.log(blob);
        var reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = function() {
          let base64data = reader.result;
          console.log(base64data);
        };
        //console.log("data:image/png;base64," + window.btoa(image));
      });

    const request = baseClient.static.getStaticImage({
      ownerId: "mapbox",
      styleId: "streets-v10",
      width: 1000,
      height: 1000,
      coordinates: [55.19734014540896, -4.460191618149105],
      geojson: {
        type: "FeatureCollection",
        features: [
          {
            type: "Polygon",
            coordinates: [
              [
                [55.19734014540896, -4.460191618149105],
                [55.19612324760185, -4.461403235618675],
                [55.19551669321881, -4.463829715512229],
                [55.1955187698018, -4.466257509370275],
                [55.19552139450015, -4.469292120452231],
                [55.19552313804621, -4.471719492873041],
                [55.19552470627515, -4.474147125928663],
                [55.194918405304, -4.476572428336765],
                [55.19492024002078, -4.478999829404111],
                [55.19492230207987, -4.48142745677016],
                [55.19553338632412, -4.484462404906444],
                [55.19675222350642, -4.486890446883627],
                [55.19675427147023, -4.489317236934393],
                [55.19736495750374, -4.491744938837872],
                [55.19858432854729, -4.494173484376585],
                [55.19919468800075, -4.4966008072529],
                [55.20163151189278, -4.499030846994227],
                [55.20284985226385, -4.500245851908662],
                [55.20528677599003, -4.503282264391032],
                [55.20711353889759, -4.50449794994311],
                [55.20954946663279, -4.506321039660268],
                [55.21198493685746, -4.507537562069026],
                [55.21320350743259, -4.509965151950295],
                [55.21442166561519, -4.51239235400648],
                [55.21503103361923, -4.514212214309641],
                [55.21685832583539, -4.517852655014701],
                [55.21746763844531, -4.51967236929182],
                [55.21929408546528, -4.521493688808651],
                [55.22233725965878, -4.522710232954124],
                [55.22477146385002, -4.523319564164746],
                [55.22781387782343, -4.523323445507255],
                [55.23024772786455, -4.523326545878229],
                [55.23207350572889, -4.523329062588987],
                [55.23450701655825, -4.523332184602094],
                [55.23937280443555, -4.522733818578853],
                [55.24119799012512, -4.522734026898378],
                [55.24302296823645, -4.522130082580969],
                [55.24545604208095, -4.521526771753988],
                [55.24788931723799, -4.520923766987225],
                [55.25032163779714, -4.519713775012931],
                [55.25214575606321, -4.517897327442257],
                [55.25518655259852, -4.516082378201403],
                [55.25761843627212, -4.51426651910677],
                [55.25944252392809, -4.513056137244366],
                [55.26126588864999, -4.509420889993054],
                [55.26308928232339, -4.505785786469771],
                [55.26369662485757, -4.503361545243059],
                [55.26551914931772, -4.499119793661712],
                [55.26612643891171, -4.496695245803198],
                [55.26612509951359, -4.493057107165209],
                [55.26612390107173, -4.490025054794826],
                [55.26612293819857, -4.487599339653993],
                [55.2655140755411, -4.485778640714276],
                [55.26490465428106, -4.48274662523377],
                [55.26490327654833, -4.47971411593568],
                [55.2642936718261, -4.476680601380498],
                [55.26368459628779, -4.473645718540867],
                [55.26246702470949, -4.471217855426936],
                [55.26124867584343, -4.468790512758904],
                [55.25942271069317, -4.466361565515918],
                [55.25759675232121, -4.464538851290916],
                [55.25516282295671, -4.463321789106951],
                [55.25394512358224, -4.461499864022568],
                [55.25151139296117, -4.460282976200227],
                [55.2484686874518, -4.459064816876425],
                [55.24664225646451, -4.457241626351557],
                [55.24420725983747, -4.456617150862062],
                [55.24177337876883, -4.455413139813875],
                [55.23873113600952, -4.454804933444571],
                [55.2356870881091, -4.453582775372667],
                [55.23203499027544, -4.452970325657372],
                [55.23081730176528, -4.452361345897024],
                [55.22777415941387, -4.452356244213364],
                [55.22351367458565, -4.452348753751593],
                [55.22046983541764, -4.452343466360542],
                [55.21742606750197, -4.452338090741689],
                [55.21194740324588, -4.45293548627554],
                [55.2095120312144, -4.452931005593697],
                [55.20707669616552, -4.452926583222157],
                [55.20464276861856, -4.454742827388479],
                [55.20220796370471, -4.455952304935751],
                [55.20038240764998, -4.457162489966723],
                [55.19794810211319, -4.45897887407234],
                [55.19734014540896, -4.460191618149105]
              ]
            ],

            properties: {
              name: "La Digue",
              description: "zone de La Digue",
              code: "sey_LaDigue",
              surface: 49512623
            }
          }
        ]
      },
      zoom: 10
    });

    const staticImageUrl = request.url();
    console.log(staticImageUrl + "?access_token=pk.eyJ1Ijoic3lsdmllZmlhdCIsImEiOiJjamk1MnZieGMwMTUxM3FxbDRhb2o5dDc3In0.V8jhcEcPBkyugxnw5gj2uw");

    var img = new Image();
    img.src = staticImageUrl + "?access_token=" + token;
    var xhr = new XMLHttpRequest();
    var self = this;
    xhr.onload = function() {
      var reader = new FileReader();
      reader.onloadend = function() {
        console.log(reader.result);
      };
      reader.readAsDataURL(xhr.response);
    };
    xhr.open("GET", staticImageUrl + "?access_token=" + token);
    xhr.responseType = "blob";
    xhr.send();

    // let base = "https://api.mapbox.com/styles/v1/mapbox/satellite-v9/static/";
    // let token = "/1280x1280?access_token=pk.eyJ1Ijoic3lsdmllZmlhdCIsImEiOiJjamk1MnZieGMwMTUxM3FxbDRhb2o5dDc3In0.V8jhcEcPBkyugxnw5gj2uw";
    // for (let z of platform.zones) {
    //   if (zone.properties.code === z.properties.code) {
    //     z = zone;
    //     break;
    //   }
    //
    //   if (z === platform.zones[platform.zones.length - 1]) {
    //     platform.zones.push(zone);
    //   }
    // }
    //
    // console.log(platform);
    // return new Promise((resolve, reject) => {
    //   var img = new Image();
    //   img.src = staticImageUrl;
    //
    //   var xhr = new XMLHttpRequest();
    //   var self = this;
    //   xhr.onload = function() {
    //     var reader = new FileReader();
    //     reader.onloadend = function() {
    //       console.log(reader.result);
    //       resolve(reader.result);
    //     };
    //     reader.readAsDataURL(xhr.response);
    //   };
    //   xhr.open("GET", staticImageUrl);
    //   xhr.responseType = "blob";
    //   xhr.send();
    // });
  }

  setSurface(geometry) {
    var surface = area.geometry(geometry);
    return parseInt(surface.toString().split(".")["0"]);
  }
}
